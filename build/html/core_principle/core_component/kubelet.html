

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>kubelet &mdash; Kubernetes alpha documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="../../_static/style.css" rel="stylesheet" type="text/css">


  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Kubernetes
          

          
            
            <img src="../../_static/kubernetes-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../deployment_guide/deployment_guide.html">部署手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core_priciple.html">核心原理</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Kubernetes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>kubelet</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/core_principle/core_component/kubelet.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="kubelet">
<h1>kubelet<a class="headerlink" href="#kubelet" title="Permalink to this headline">¶</a></h1>
<p>每个节点上都运行一个 kubelet 服务进程，默认监听 10250 端口，接收并执行 master 发来指令，管理 Pod 及 Pod 中的容器。每个 kubelet 进程会在 API Server 上注册节点自身信息，定期向 master 节点汇报节点的资源使用情况，并通过 cAdvisor 监控节点和容器的资源。</p>
<div class="section" id="id1">
<h2>节点管理<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>节点管理主要是节点自注册和节点状态更新：</p>
<ul class="simple">
<li>Kubelet 可以通过设置启动参数 –register-node 来确定是否向 API Server 注册自己；</li>
<li>如果 Kubelet 没有选择自注册模式，则需要用户自己配置 Node 资源信息，同时需要告知 Kubelet 集群上的 API Server 的位置；</li>
<li>Kubelet 在启动时通过 API Server 注册节点信息，并定时向 API Server 发送节点新消息，API Server 在接收到新消息后，将信息写入 etcd。</li>
</ul>
</div>
<div class="section" id="pod">
<h2>Pod 管理<a class="headerlink" href="#pod" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id2">
<h3>获取 Pod 清单<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Kubelet 以 PodSpec 的方式工作。PodSpec 是描述一个 Pod 的 YAML 或 JSON 对象。kubelet 采用一组通过各种机制提供的 PodSpecs（主要通过 apiserver），并确保这些 Podspecs 中描述的 Pod 正常健康运行。</p>
<p>向 Kubelet 提供节点上需要运行的 Pod 清单的方法：</p>
<ul class="simple">
<li>文件：启动参数 –config 指定的配置目录下的文件（默认 /etc/kubernetes/manifests/）。该文件每 20 秒重现检查一次（可配置）。</li>
<li>HTTP endpoint（URL）：启动参数 –manifest-url 设置。每 20 秒检查一次这个端点（可配置）。</li>
<li>API Server：通过 API Server 监听 etcd 目录，同步 Pod 清单。</li>
<li>HTTP Server：kubelet 监听 HTTP 请求，并响应简单的 API 以提交新的 Pod 清单。</li>
</ul>
</div>
<div class="section" id="api-server-pod-pod">
<h3>通过 API Server 获取 Pod 清单及创建 Pod 的过程<a class="headerlink" href="#api-server-pod-pod" title="Permalink to this headline">¶</a></h3>
<p>Kubelet 通过 API Server Client（Kubelet 启动时创建）使用 Watch 加 List 的方式监听 “/registry/nodes/$当前节点名”和”/registry/pods”目录，将获取的信息同步到本地缓存中。</p>
<p>Kubelet 监听 etcd，所有针对 Pod 的操作都将会被 Kubelet 监听到。如果发现有心的绑定到本节点的 Pod，则按照 Pod 清单的要求创建该 Pod。</p>
<p>如果发现本地的 Pod 被修改，则 Kubelet 会做出相应的修改，比如删除 Pod 中某个容器时，则通过 Docker Client 删除该容器。如果发现删除本节点的 Pod，则删除相应的 Pod，则通过 Docker Client 删除 Pod 中的容器。</p>
<p>Kubelet 读取监听到的信息，如果是创建和修改 Pod 任务，则执行如下处理：</p>
<ul>
<li><p class="first">为该 Pod 创建一个数据目录；</p>
</li>
<li><p class="first">从 API Server 读取该 Pod 清单；</p>
</li>
<li><p class="first">为该 Pod 挂载外部卷；</p>
</li>
<li><p class="first">下载 Pod 用到的 Secret；</p>
</li>
<li><p class="first">检查已经在节点上运行的 Pod，如果该 Pod 没有容器或 Pause 容器没有启动，则先停止 Pod 里所有容器的进程。如果在 Pod 中有需要删除的容器，则删除这些容器；</p>
</li>
<li><p class="first">用 “kubernetes/pause” 镜像为每个 Pod 创建一个容器。Pause 容器用于接管 Pod 中所有其他容器的网络。每创建一个新的 Pod，kubelet 都会先创建一个 Pause 容器，然后创建其他容器。</p>
</li>
<li><p class="first">为 Pod 中的每个容器做如下处理：</p>
<blockquote>
<div><ol class="arabic simple">
<li>为容器计算一个 hash 值，然后用容器的名字去 Docker 查询对应容器的 hash 值。若查找到容器，且两者 hash 值不同，则停止与之关联的 Pause 容器的进程；若两者相同，则不做任何处理；</li>
<li>如果容器被终止了，且容器没有指定的 restartPolicy，则不做任何处理；</li>
<li>调用 Docker Client 下载容器镜像，调用 Docker Client 运行容器。</li>
</ol>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="static-pod">
<h3>Static Pod<a class="headerlink" href="#static-pod" title="Permalink to this headline">¶</a></h3>
<p>所有以非 API Server 方式创建的 Pod 都叫 Static Pod。Kubelet 将 Static Pod 的状态汇报给 API Server，API Server 为该 Static Pod 创建一个 Mirror Pod 和其相匹配。Mirror Pod 的状态将真实反映 Static Pod 的状态。当 Static Pod 被删除时，与之相对应的 Mirror Pod 也会被删除。</p>
</div>
</div>
<div class="section" id="id3">
<h2>容器检查检查<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>Pod 通过两类探针检查容器的健康状态：</p>
<ul class="simple">
<li><ol class="first arabic">
<li>LiveessProbe 探针：用于判断容器是否健康，告诉 Kubelet 一个容器什么时候处于不健康的状态。如果 LivenessProbe 探针探测到容器不健康，则 Kubelet 将删除该容器，并根据容器的重启策略做相应的处理。如果一个容器不包含 LivenessProbe 探针，那么 Kubelet 认为该容器的 LivenessProbe 探针返回的值永远是 “Success”；</li>
</ol>
</li>
<li><ol class="first arabic" start="2">
<li>ReadinessProbe：用于判断容器是否启动完成且准备接受请求。如果 ReadinessProbe 探针探测到失败，则 Pod 的状态将被修改。Endpoint Controller 将从 Service 的 Endpoint 中删除包含该容器所在 Pod 的 IP 地址的 Endpoint 条目。</li>
</ol>
</li>
</ul>
<p>Kubelet 定期调用容器中的 LivenessProbe 探针来诊断容器的健康状况。LivenessProbe 包含如下三种实现方式：</p>
<ul class="simple">
<li>ExecAction：在容器内部执行一个命令，如果该命令的退出状态码为 0，则表明容器健康。</li>
<li>TCPSocketAction：通过容器的 IP 地址和端口号执行 TCP 检查，如果端口能被访问，则表明容器健康；</li>
<li>HTTPGetAction：通过容器的 IP 地址和端口号及路径调用 HTTP GET 方法，如果响应的状态码大于等于 200 且小于 400，则认为容器状态健康。</li>
</ul>
<p>LivenessProbe 探针包含在 Pod 定义的 spec.containers.{某个容器} 中。</p>
</div>
<div class="section" id="cadvisor">
<h2>cAdvisor 资源监控<a class="headerlink" href="#cadvisor" title="Permalink to this headline">¶</a></h2>
<p>Kubernetes 集群中，应用程序的执行情况可以在不同的级别上检测到，这些几倍包括：容器、Pod、Service 和整个集群。Heapster 项目为 kubernetes 提供了一个基本的监控平台，它是集群级别的监控和事件数据集成器（Aggregator）。Heapster 以 Pod 的方式运行在集群中，Heapster 通过 Kuberlet 发现所有运行在集群中的节点，并查看来自这些节点的资源使用情况。Kubelet 通过 cAdvisor 获取其所在节点及容器的数据。Heapster 通过带着关联标签的 Pod 分组这些信息，这些数据将被推到一个可配置的后端，用于存储和可视化展示。支持的后端包括 InfluxDB (使用 Grafana 实现可视化)和 Google Clude Monitoring。</p>
<p>cAdvisor 是一个开源的分析容器资源使用率和性能特性的代理工具，以集成到 Kubernetes 代码中。cAdvisor 自动查找所有在其所在节点上的容器，自动采集 CPU、内存、文件系统和网络使用的统计信息。cAdvisor 通过它所在节点机的 Root 容器，采集并分析该节点机的全面使用情况。</p>
<p>cAdvisor 通过其所在节点机的 4194 端口暴露一个简单的 UI。</p>
</div>
<div class="section" id="kubelet-eviction">
<h2>Kubelet Eviction（驱逐）<a class="headerlink" href="#kubelet-eviction" title="Permalink to this headline">¶</a></h2>
<p>Kubelet 会监控资源的使用情况，并使用驱逐机制防止计算和存储资源耗尽。在驱逐时，Kubelet 将 Pod 的所有容器停止，并将 PodPhase 设置为 Failed。</p>
<p>Kubelet 定期（<cite>housekeeping-interval</cite>）检查系统的资源是否达到了预先配置的驱逐阈值，包括：</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="7%" />
<col width="84%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ion Signal</th>
<th class="head">Condition</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>memory.available</td>
<td>MemoryPressure</td>
<td><cite>memory.available</cite> = <cite>node.status.capacity[memory] - node.stats.memory.workingSet</cite> (&lt;计算方法参考 <a class="reference external" href="https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/memory-available.sh">https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/memory-available.sh</a>&gt;_)</td>
</tr>
<tr class="row-odd"><td>nodefs.available</td>
<td>DiskPressure</td>
<td><cite>nodefs.available</cite> = <a href="#id4"><span class="problematic" id="id5">`</span></a>node.stats.fs.available`（Kubelet Volume 以及日志等）</td>
</tr>
<tr class="row-even"><td>nodefs.inodesFree</td>
<td>DiskPressure</td>
<td><cite>nodefs.inodesFree</cite> = <cite>node.stats.fs.inodesFree</cite></td>
</tr>
<tr class="row-odd"><td>imagefs.available</td>
<td>DiskPressure</td>
<td><cite>imagefs.available</cite> = <a href="#id6"><span class="problematic" id="id7">`</span></a>node.stats.runtime.imagefs.available`（镜像以及容器可写层等）</td>
</tr>
<tr class="row-even"><td>imagefs.inodesFree</td>
<td>DiskPressure</td>
<td><cite>imagefs.inodesFree</cite> = <cite>node.stats.runtime.imagefs.inodesFree</cite></td>
</tr>
</tbody>
</table>
<p>这些驱逐阈值可以使用百分比，也可以使用绝对值，如</p>
<p>这些驱逐信号可以分为软驱逐和硬驱逐</p>
<ul class="simple">
<li>软驱逐（Soft Eviction）：配合驱逐宽限期（eviction-soft-grace-period 和 eviction-max-pod-grace-period）一起使用。系统资源达到软驱逐阈值并在超过宽限期之后才会执行驱逐动作。</li>
<li>硬驱逐（Hard Eviction）：系统资源达到硬驱逐阈值时立即执行驱逐动作。</li>
</ul>
<p>驱逐动作包括回收节点资源和驱逐用户 Pod 两种：</p>
<ul>
<li><p class="first">回收节点资源</p>
<blockquote>
<div><ul>
<li><p class="first">配置了 imagefs 阈值时</p>
<blockquote>
<div><ul class="simple">
<li>达到 nodefs 阈值：删除已停止的 Pod</li>
<li>达到 imagefs 阈值：删除未使用的镜像</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">未配置 imagefs 阈值时</p>
<blockquote>
<div><ul class="simple">
<li>达到 nodefs 阈值时，按照删除已停止的 Pod 和删除未使用镜像的顺序清理资源</li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">驱逐用户 Pod</p>
<blockquote>
<div><ul>
<li><p class="first">驱逐顺序为：BestEffof、Burstable、Guaranteed</p>
</li>
<li><p class="first">配置了 imagefs 阈值时</p>
<blockquote>
<div><ul class="simple">
<li>达到 nodefs 阈值，基于 nodefs 用量驱逐（local volume + logs）</li>
<li>达到 imagefs 阈值，基于 imagefs 用量驱逐（容器可写层）</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">未配置 imagefs 阈值时</p>
<blockquote>
<div><ul class="simple">
<li>达到 nodefs 阈值时，按照总磁盘使用驱逐（local volume + logs + 容器可写层）</li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id8">
<h2>容器运行时<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, renkeju.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'alpha',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>