

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>API Server &mdash; Kubernetes alpha documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Kubernetes alpha documentation" href="../../index.html"/>
    <link href="../../_static/style.css" rel="stylesheet" type="text/css">


  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Kubernetes
          

          
            
            <img src="../../_static/kubernetes-logo.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../deployment_guide/deployment_guide.html">部署手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core_priciple.html">核心原理</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Kubernetes</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>API Server</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/core_principle/core_component/api_server.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="api-server">
<h1>API Server<a class="headerlink" href="#api-server" title="Permalink to this headline">¶</a></h1>
<p>Kuber-apiserver 是 Kubernetes 最重要的核心组件之一，主要提供一下的功能</p>
<ul class="simple">
<li>提供集群管理的 REST API 接口，包括认证授权、数据校验以及集群状态变更等</li>
<li>提供其他模块之间的数据交互和通讯的枢纽（其他模块通过 API Server 查询或修改数据，只有 API Server 才直接操作 etcd）</li>
</ul>
<div class="section" id="rest-api">
<h2>REST API<a class="headerlink" href="#rest-api" title="Permalink to this headline">¶</a></h2>
<p>kube-apiserver 支持同时提供 https（默认监听在 6443 端口）和 http API (默认监听在 127.0.0.1 的 8080 端口)，其中 http API 是非安全接口，不做任何认证授权机制，不建议生产环境启用。两个接口提供 REST API 格式相同，参考 <a class="reference external" href="https://kubernetes.io/docs/api-reference/v1.8/">Kubernetes API Reference</a> 查看所有 API 的调用格式。</p>
<p>在实际使用中，通常通过 kubectl 来访问 apiserver，也可以通过 Kubernetes 各个语言的 client 库来访问 apiserver。在使用 kubectl 时，打开调用日志也可以看到每个 API 调用的格式，比如：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl --v<span class="o">=</span><span class="m">8</span> get pods
</pre></div>
</div>
<p>可以通过 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">api-versions</span></code> 和 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">api-resources</span></code> 查询 Kubernetes API 支持的 API 版本以及资源对象。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl api-versions
admissionregistration.k8s.io/v1beta1
apiextensions.k8s.io/v1beta1
apiregistration.k8s.io/v1beta1
apps.openshift.io/v1
apps/v1
apps/v1beta1
apps/v1beta2
authentication.k8s.io/v1
authentication.k8s.io/v1beta1
authorization.k8s.io/v1
authorization.k8s.io/v1beta1
authorization.openshift.io/v1
autoscaling/v1
autoscaling/v2beta1
batch/v1
batch/v1beta1
batch/v2alpha1
build.openshift.io/v1
certificates.k8s.io/v1beta1
events.k8s.io/v1beta1
extensions/v1beta1
image.openshift.io/v1
network.openshift.io/v1
networking.k8s.io/v1
oauth.openshift.io/v1
policy/v1beta1
project.openshift.io/v1
quota.openshift.io/v1
rbac.authorization.k8s.io/v1
rbac.authorization.k8s.io/v1beta1
route.openshift.io/v1
security.openshift.io/v1
servicecatalog.k8s.io/v1beta1
settings.k8s.io/v1alpha1
storage.k8s.io/v1
storage.k8s.io/v1beta1
template.openshift.io/v1
user.openshift.io/v1
v1

$ kubectl api-resources --api-group<span class="o">=</span>storage.k8s.io
NAME             SHORTNAMES   APIGROUP         NAMESPACED   KIND
storageclasses   sc           storage.k8s.io   <span class="nb">false</span>        StorageClass
</pre></div>
</div>
</div>
<div class="section" id="openapi-swagger">
<h2>OpenAPI 和 Swagger<a class="headerlink" href="#openapi-swagger" title="Permalink to this headline">¶</a></h2>
<p>通过 <code class="docutils literal notranslate"><span class="pre">/Swaggerapi</span></code> 可以查看 Swagger API，<code class="docutils literal notranslate"><span class="pre">/openapi/v2</span></code> 查看 OpenAPI。
开启 <code class="docutils literal notranslate"><span class="pre">--enable-swagger-ui=true</span></code> 后还可以通过 <code class="docutils literal notranslate"><span class="pre">/swagger-ui</span></code> 访问 Swagger UI。
根据 OpenAPI 也可以生成各种语言的客户端，比如可以用下面的命令生成 Go 语言的客户端：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/kubernetes-client/gen /tmp/gen
cat &gt;go.settings <span class="s">&lt;&lt;EOF</span>
<span class="s"># Kubernetes branch name</span>
<span class="s">export KUBERNETES_BRANCH=&quot;release-1.11&quot;</span>

<span class="s"># client version for packaging and releasing.</span>
<span class="s">export CLIENT_VERSION=&quot;1.0&quot;</span>

<span class="s"># Name of the release package</span>
<span class="s">export PACKAGE_NAME=&quot;client-go&quot;</span>
<span class="s">EOF</span>

/tmp/gen/openapi/go.sh ./client-go ./go.settings
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>访问控制<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Kubernetes API 的每个请求都会经过多阶段的访问控制之后才会被接受，这包括认证、授权以及准入控制（Admission Control）等。</p>
<img alt="../../_images/access_control.png" src="../../_images/access_control.png" />
</div>
<div class="section" id="id2">
<h2>认证<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>开启 TLS 时，所有请求都需要首先认证。Kubernetes 支持多种认证机制，并支持同时开启多个认证插件（只要有一个认证通过即可）。如果认证成功，则用户的 <code class="docutils literal notranslate"><span class="pre">username</span></code> 会传入授权模块做进一步授权验证；而对于认证失败的请求则返回 HTTP 401。</p>
<div class="line-block">
<div class="line"><strong>Kubernetes 不直接管理用户</strong></div>
<div class="line">虽然 Kubernetes 认证和授权用到了 username，但 Kubernetes 并不直接管理用户，不能创建 <code class="docutils literal notranslate"><span class="pre">user</span></code> 对象，也不存储 username。</div>
</div>
<p>更多认证模块的使用方法可以参考 Kubernetes 认证插件。</p>
</div>
<div class="section" id="id3">
<h2>授权<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>认证之后的请求就到了授权模块。跟认证类似，Kubernetes 也支持多种授权机制，并支持同时开启多个授权插件（只要有一个验证通过即可）。如果授权成功，则用户的请求会发送到准入控制模块做进一步的请求验证；而对于授权失败的请求则返回 HTTP 403。</p>
<p>更多授权模块的使用方法可以参考 Kubernetes 授权插件。</p>
</div>
<div class="section" id="id4">
<h2>准入控制<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>准入控制（Admission Control）用来对请求做进一步的验证或添加默认参数。不同于授权和认证只关心请求的用户和操作，准入控制还处理请求的内容，并且仅对创建、更新、删除或连接（如代理）等有效，而对读操作无效。准入控制也支持同时开启多个插件，他们依次调用，只有全部插件都通过请求才可以放过进入系统。</p>
</div>
<div class="section" id="apiserver">
<h2>启动 apiserver 示例<a class="headerlink" href="#apiserver" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>kube-apiserver --feature-gates=AllAlpha=true --runtime-config=api/all=true \
    --requestheader-allowed-names=front-proxy-client \
    --client-ca-file=/etc/kubernetes/pki/ca.crt \
    --allow-privileged=true \
    --experimental-bootstrap-token-auth=true \
    --storage-backend=etcd3 \
    --requestheader-username-headers=X-Remote-User \
    --requestheader-extra-headers-prefix=X-Remote-Extra- \
    --service-account-key-file=/etc/kubernetes/pki/sa.pub \
    --tls-cert-file=/etc/kubernetes/pki/apiserver.crt \
    --tls-private-key-file=/etc/kubernetes/pki/apiserver.key \
    --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt \
    --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt \
    --insecure-port=8080 \
    --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds \
    --requestheader-group-headers=X-Remote-Group \
    --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key \
    --secure-port=6443 \
    --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \
    --service-cluster-ip-range=10.96.0.0/12 \
    --authorization-mode=RBAC \
    --advertise-address=192.168.0.20 --etcd-servers=http://127.0.0.1:2379
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h2>工作原理<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>Kube-apiserver 提供了 Kubernetes 的 REST API，实现了认证、授权、准入控制等安全校验功能，同时也负责集群状态的存储操作（通过 etcd）。</p>
<img alt="../../_images/kube-apiserver.png" src="../../_images/kube-apiserver.png" />
</div>
<div class="section" id="api">
<h2>API 访问<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<p>有多种方式可以访问 Kubernetes 提供的 REST API：</p>
<ul>
<li><p class="first"><a class="reference external" href="https://kubernetes.feisky.xyz/zh/components/kubectl.html">kubectl</a> 命令行工具</p>
</li>
<li><p class="first">SDK，支持多种语言</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://github.com/kubernetes/client-go">Go</a></li>
<li><a class="reference external" href="https://github.com/kubernetes-incubator/client-python">Python</a></li>
<li><a class="reference external" href="https://github.com/kubernetes-client/javascript">javascript</a></li>
<li><a class="reference external" href="https://github.com/kubernetes-client/java">Java</a></li>
<li><a class="reference external" href="https://github.com/kubernetes-client/csharp">CSharp</a></li>
<li>其他 <a class="reference external" href="https://www.openapis.org/">OpenAPI</a> 支持的语言，可以通过 <a class="reference external" href="https://github.com/kubernetes-client/gen">gen</a> 工具生成相应的 client</li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id6">
<h2>kubectl<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl get --raw /api/v1/namespaces
kubectl get --raw /apis/metrics.k8s.io/v1beta1/nodes
kubectl get --raw /apis/metrics.k8s.io/v1beta1/pods
</pre></div>
</div>
</div>
<div class="section" id="kubectl-proxy">
<h2>kubectl proxy<a class="headerlink" href="#kubectl-proxy" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl proxy --port<span class="o">=</span><span class="m">8080</span> <span class="p">&amp;</span>

$ curl http://localhost:8080/api/
<span class="o">{</span>
  <span class="s2">&quot;versions&quot;</span>: <span class="o">[</span>
    <span class="s2">&quot;v1&quot;</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="curl">
<h2>curl<a class="headerlink" href="#curl" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># In Pods with service account.</span>
$ <span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>cat /run/secrets/kubernetes.io/serviceaccount/token<span class="k">)</span>
$ <span class="nv">CACERT</span><span class="o">=</span>/run/secrets/kubernetes.io/serviceaccount/ca.crt
$ curl --cacert <span class="nv">$CACERT</span> --header <span class="s2">&quot;Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">&quot;</span>  https://<span class="nv">$KUBERNETES_SERVICE_HOST</span>:<span class="nv">$KUBERNETES_SERVICE_PORT</span>/api
<span class="o">{</span>
  <span class="s2">&quot;kind&quot;</span>: <span class="s2">&quot;APIVersions&quot;</span>,
  <span class="s2">&quot;versions&quot;</span>: <span class="o">[</span>
    <span class="s2">&quot;v1&quot;</span>
  <span class="o">]</span>,
  <span class="s2">&quot;serverAddressByClientCIDRs&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;clientCIDR&quot;</span>: <span class="s2">&quot;0.0.0.0/0&quot;</span>,
      <span class="s2">&quot;serverAddress&quot;</span>: <span class="s2">&quot;10.0.1.149:443&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Outside of Pods.</span>
$ <span class="nv">APISERVER</span><span class="o">=</span><span class="k">$(</span>kubectl config view <span class="p">|</span> grep server <span class="p">|</span> cut -f <span class="m">2</span>- -d <span class="s2">&quot;:&quot;</span> <span class="p">|</span> tr -d <span class="s2">&quot; &quot;</span><span class="k">)</span>
$ <span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>kubectl describe secret <span class="k">$(</span>kubectl get secrets <span class="p">|</span> grep default <span class="p">|</span> cut -f1 -d <span class="s1">&#39;&#39;</span><span class="k">)</span> <span class="p">|</span> grep -E<span class="s1">&#39;^token&#39;</span><span class="p">|</span> cut -f2 -d<span class="s1">&#39;:&#39;</span><span class="p">|</span> tr -d<span class="s1">&#39;\t&#39;</span><span class="k">)</span>
$ curl <span class="nv">$APISERVER</span>/api --header <span class="s2">&quot;Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">&quot;</span> --insecure
<span class="o">{</span>
  <span class="s2">&quot;kind&quot;</span>: <span class="s2">&quot;APIVersions&quot;</span>,
  <span class="s2">&quot;versions&quot;</span>: <span class="o">[</span>
    <span class="s2">&quot;v1&quot;</span>
  <span class="o">]</span>,
  <span class="s2">&quot;serverAddressByClientCIDRs&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;clientCIDR&quot;</span>: <span class="s2">&quot;0.0.0.0/0&quot;</span>,
      <span class="s2">&quot;serverAddress&quot;</span>: <span class="s2">&quot;10.0.1.149:443&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h2>API 参考文档<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>最近 4 个稳定版本的 API 参看文档为：</p>
<ul class="simple">
<li><a class="reference external" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/">v1.11 API Reference</a></li>
<li><a class="reference external" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.10/">v1.10 API Reference</a></li>
<li><a class="reference external" href="https://kubernetes.io/docs/api-reference/v1.9/">v1.9 API Reference</a></li>
<li><a class="reference external" href="https://kubernetes.io/docs/api-reference/v1.8/">v1.8 API Reference</a></li>
</ul>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, renkeju.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'alpha',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>