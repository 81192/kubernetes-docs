

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>在 Kubespary 中升级 Kubernetes &mdash; Kubernetes alpha documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="../../_static/style.css" rel="stylesheet" type="text/css">


  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Kubernetes
          

          
            
            <img src="../../_static/kubernetes-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../container/container.html">容器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment_guide.html">部署手册</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Kubernetes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>在 Kubespary 中升级 Kubernetes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/deployment_guide/kubespray/upgradeing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="kubespary-kubernetes">
<h1>在 Kubespary 中升级 Kubernetes<a class="headerlink" href="#kubespary-kubernetes" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>描述<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Kubespray 处理升级的方式与处理初始部署的方式相同。 也就是说，每个组件都按固定顺序放置。
您应该可以毫无困难地在 Kubespray 把当前集群升级到 tags 2.0。 您还可以通过显式定义其版本来单独控制组件的版本。</p>
<p>以下是每个组件的所有版本变量：</p>
<ul class="simple">
<li>docker_version</li>
<li>kube_version</li>
<li>etcd_version</li>
<li>calico_version</li>
<li>calico_cni_version</li>
<li>weave_version</li>
<li>flannel_version</li>
<li>kubedns_version</li>
</ul>
</div>
<div class="section" id="id2">
<h2>不安全的升级示例<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>如果您只想将 kube_version 从 v1.4.3 升级到 v1.4.6，则可以采用以下方式进行部署：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ansible-playbook cluster.yml -i inventory/sample/hosts.ini -e kube_version=v1.4.3
</pre></div>
</div>
<p>然后重复用 v1.4.6 作为 kube_version：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ansible-playbook cluster.yml -i inventory/sample/hosts.ini -e kube_version=v1.4.6
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>优雅的升级<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>Kubespray还支持在执行群集升级时对节点进行锁定，排空和取消协调。有一个单独的 playbook 用于此目的。请务必注意，upgrade-cluster.yml 只能用于升级现有群集。这意味着必须至少部署了1个kube-master。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git fetch origin
git checkout origin/master
ansible-playbook upgrade-cluster.yml -b -i inventory/sample/hosts.ini -e <span class="nv">kube_version</span><span class="o">=</span>v1.6.0
</pre></div>
</div>
<p>成功升级后，查看更新服务器版本：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl version
Client Version: version.Info<span class="o">{</span>Major:<span class="s2">&quot;1&quot;</span>, Minor:<span class="s2">&quot;6&quot;</span>, GitVersion:<span class="s2">&quot;v1.6.0&quot;</span>, GitCommit:<span class="s2">&quot;fff5156092b56e6bd60fff75aad4dc9de6b6ef37&quot;</span>, GitTreeState:<span class="s2">&quot;clean&quot;</span>, BuildDate:<span class="s2">&quot;2017-03-28T19:15:41Z&quot;</span>, GoVersion:<span class="s2">&quot;go1.8&quot;</span>, Compiler:<span class="s2">&quot;gc&quot;</span>, Platform:<span class="s2">&quot;darwin/amd64&quot;</span><span class="o">}</span>
Server Version: version.Info<span class="o">{</span>Major:<span class="s2">&quot;1&quot;</span>, Minor:<span class="s2">&quot;6&quot;</span>, GitVersion:<span class="s2">&quot;v1.6.0+coreos.0&quot;</span>, GitCommit:<span class="s2">&quot;8031716957d697332f9234ddf85febb07ac6c3e3&quot;</span>, GitTreeState:<span class="s2">&quot;clean&quot;</span>, BuildDate:<span class="s2">&quot;2017-03-29T04:33:09Z&quot;</span>, GoVersion:<span class="s2">&quot;go1.7.5&quot;</span>, Compiler:<span class="s2">&quot;gc&quot;</span>, Platform:<span class="s2">&quot;linux/amd64&quot;</span><span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2>升级管理<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>如上所述，组件按照它们在Ansible playbook中的安装顺序进行升级。组件安装顺序如下：</p>
<ul class="simple">
<li>Docker</li>
<li>etcd</li>
<li>kubelet and kube-proxy</li>
<li>network_plugin (such as Calico or Weave)</li>
<li>kube-apiserver, kube-scheduler, and kube-controller-manager</li>
<li>Add-ons (such as KubeDNS)</li>
</ul>
</div>
<div class="section" id="id5">
<h2>升级注意事项<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>Kubespray 支持用于etcd和Kubernetes 组件的轮换证书，但可能需要一些手动操作步骤。
如果您的 pod 需要使用服务令牌并部署在 kube-system 以外的命名空间中，则需要在轮换证书后手动删除受影响的pod。
这是因为所有服务帐户令牌都依赖于用于生成它们的 apiserver 令牌。
证书轮换时，所有服务帐户 token 也必须轮换。 在 kubernetes-apps/rotate_tokens 角色期间，只有 kube-system 中的 pod 被销毁并重新创建。
所有其他无效的服务帐户令牌都会自动清理，但是对于对用户部署的pod的影响，其他pod不会被删除。</p>
</div>
<div class="section" id="id6">
<h2>基于组件的升级<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>部署者可能希望升级特定组件以最小化风险或节省时间。
在撰写本文时，CI 不涵盖此策略，因此无法保证其正常运行。</p>
<p>这些命令仅对升级完全部署的健康现有主机有用。
这对于未部署或部分部署的主机肯定不起作用。</p>
<p>Upgrade docker:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -b -i inventory/sample/hosts.ini cluster.yml --tags<span class="o">=</span>docker
</pre></div>
</div>
<p>Upgrade etcd:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -b -i inventory/sample/hosts.ini cluster.yml --tags<span class="o">=</span>etcd
</pre></div>
</div>
<p>Upgrade vault:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -b -i inventory/sample/hosts.ini cluster.yml --tags<span class="o">=</span>vault
</pre></div>
</div>
<p>Upgrade kubelet:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -b -i inventory/sample/hosts.ini cluster.yml --tags<span class="o">=</span>node --skip-tags<span class="o">=</span>k8s-gen-certs,k8s-gen-tokens
</pre></div>
</div>
<p>Upgrade Kubernetes master components:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -b -i inventory/sample/hosts.ini cluster.yml --tags<span class="o">=</span>master
</pre></div>
</div>
<p>Upgrade network plugins:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -b -i inventory/sample/hosts.ini cluster.yml --tags<span class="o">=</span>network
</pre></div>
</div>
<p>Upgrade all add-ons:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -b -i inventory/sample/hosts.ini cluster.yml --tags<span class="o">=</span>apps
</pre></div>
</div>
<p>仅升级 helm（假设 helm_enabled 为 true）：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -b -i inventory/sample/hosts.ini cluster.yml --tags<span class="o">=</span>helm
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, renkeju.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'alpha',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>