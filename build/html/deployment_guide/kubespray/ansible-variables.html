

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Ansible 变量 &mdash; Kubernetes alpha documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="../../_static/style.css" rel="stylesheet" type="text/css">


  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Kubernetes
          

          
            
            <img src="../../_static/kubernetes-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../container/container.html">容器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment_guide.html">部署手册</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Kubernetes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Ansible 变量</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/deployment_guide/kubespray/ansible-variables.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ansible">
<h1>Ansible 变量<a class="headerlink" href="#ansible" title="Permalink to this headline">¶</a></h1>
<div class="section" id="inventory">
<h2>Inventory<a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h2>
<p>inventory 由 3 组内容组成</p>
<ul class="simple">
<li>kube-master : 将运行 kubernetes 主组件（apiserver，scheduler，controller）的服务器列表。</li>
<li>kube-node : 将运行 pod 的 kubernetes 节点列表。</li>
<li>etcd : 组成 etcd 服务器的服务器列表。您应该至少有3台服务器用于故障转移。</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">不要修改 k8s-cluster 的子类，比如将 etcd 组放入 k8s-cluster 组中，除非你确定要这样做并且你完全包含在后者中：</p>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>k8s-cluster ⊂ etcd =&gt; kube-node ∩ etcd = etcd
</pre></div>
</div>
<p>当 kube-node 包含 etcd 时，您可以将您的 etcd 集群定义为可以为 Kubernetes 工作负载调度。 如果您想要它是独立的，请确保这些组不相交。 如果您希望服务器同时充当主服务器和节点，则必须在kube-master和kube-node两个组上定义服务器。 如果需要独立且不可调度的主服务器，则必须仅在 kube-master 而不是 kube-node 中定义服务器。</p>
<p>还有两个特殊的群组：</p>
<ul class="simple">
<li>calico-rr : 查看 <a class="reference external" href="https://github.com/kubernetes-incubator/kubespray/blob/master/docs/calico.md">先进的 Calico 网络案例</a> 。</li>
<li>bastion : 如果您的节点不可直接访问，请配置堡垒主机。</li>
</ul>
<p>以下是完整的 inventory 示例:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">## Configure &#39;ip&#39; variable to bind kubernetes services on a</span>
<span class="c1">## different ip than the default iface</span>
<span class="na">node1 ansible_ssh_host</span><span class="o">=</span><span class="s">95.54.0.12 ip=10.3.0.1</span>
<span class="na">node2 ansible_ssh_host</span><span class="o">=</span><span class="s">95.54.0.13 ip=10.3.0.2</span>
<span class="na">node3 ansible_ssh_host</span><span class="o">=</span><span class="s">95.54.0.14 ip=10.3.0.3</span>
<span class="na">node4 ansible_ssh_host</span><span class="o">=</span><span class="s">95.54.0.15 ip=10.3.0.4</span>
<span class="na">node5 ansible_ssh_host</span><span class="o">=</span><span class="s">95.54.0.16 ip=10.3.0.5</span>
<span class="na">node6 ansible_ssh_host</span><span class="o">=</span><span class="s">95.54.0.17 ip=10.3.0.6</span>

<span class="k">[kube-master]</span>
<span class="na">node1</span>
<span class="na">node2</span>

<span class="k">[etcd]</span>
<span class="na">node1</span>
<span class="na">node2</span>
<span class="na">node3</span>

<span class="k">[kube-node]</span>
<span class="na">node2</span>
<span class="na">node3</span>
<span class="na">node4</span>
<span class="na">node5</span>
<span class="na">node6</span>

<span class="k">[k8s-cluster:children]</span>
<span class="na">kube-node</span>
<span class="na">kube-master</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>组变量和覆盖优先级变量<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>用于控制主要部署选项的组变量位于目录 <code class="docutils literal notranslate"><span class="pre">inventory/sample/group_vars</span></code> 中。 可选变量位于 <code class="docutils literal notranslate"><span class="pre">inventory/sample/group_vars/all.yml</span></code> 中。 可以在 <code class="docutils literal notranslate"><span class="pre">inventory/sample/group_vars/k8s-cluster.yml</span></code> 中找到至少一个角色（或节点组）通用的强制变量。 还有 <cite>docker</cite>，<cite>rkt</cite>，<cite>kubernetes preinstall</cite> 和 <cite>master</cite> 角色的角色变量。 根据 ansible 文档，那些不能从组变量中覆盖。 为了覆盖，应该使用 <code class="docutils literal notranslate"><span class="pre">-e</span></code> 运行时标志（最简单的方法）或文档中描述的其他层。</p>
<p>Kubespray只使用几个层来覆盖事物（或者期望它们被替换为角色）：</p>
<table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Layer</th>
<th class="head">Comment</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>role defaults</td>
<td>provides best UX to override things for Kubespray deployments</td>
</tr>
<tr class="row-odd"><td>inventory vars</td>
<td>Unused</td>
</tr>
<tr class="row-even"><td>inventory group_vars</td>
<td>Expects users to use all.yml,k8s-cluster.yml etc. to override things</td>
</tr>
<tr class="row-odd"><td>inventory host_vars</td>
<td rowspan="3">Unused</td>
</tr>
<tr class="row-even"><td>playbook group_vars</td>
</tr>
<tr class="row-odd"><td>playbook host_vars</td>
</tr>
<tr class="row-even"><td>host facts</td>
<td>Kubespray overrides for internal roles’ logic, like state flags</td>
</tr>
<tr class="row-odd"><td>play vars</td>
<td rowspan="4">Unused</td>
</tr>
<tr class="row-even"><td>play vars_prompt</td>
</tr>
<tr class="row-odd"><td>play vars_files</td>
</tr>
<tr class="row-even"><td>registered vars</td>
</tr>
<tr class="row-odd"><td>set_facts</td>
<td>Kubespray overrides those, for some places</td>
</tr>
<tr class="row-even"><td>role and include vars</td>
<td>Provides bad UX to override things! Use extra vars to enforce</td>
</tr>
<tr class="row-odd"><td>block vars (only for tasks in block)</td>
<td>Kubespray overrides for internal roles’ logic</td>
</tr>
<tr class="row-even"><td>task vars (only for the task)</td>
<td>Unused for roles, but only for helper scripts</td>
</tr>
<tr class="row-odd"><td>extra vars (always win precedence)</td>
<td>override with ansible-playbook -e &#64;foo.yml</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id2">
<h2>Ansible 标签<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>playbooks 定义了以下的标记：</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Tag name</td>
<td>User for</td>
</tr>
<tr class="row-even"><td>apps</td>
<td>K8s apps 定义</td>
</tr>
<tr class="row-odd"><td>azure</td>
<td>Cloud-provider Azure</td>
</tr>
<tr class="row-even"><td>bastion</td>
<td>Setup ssh config for bastion</td>
</tr>
<tr class="row-odd"><td>bootstrap-os</td>
<td>Anything related to host OS configuration</td>
</tr>
<tr class="row-even"><td>network</td>
<td>Configuring networking plugins for K8s</td>
</tr>
<tr class="row-odd"><td>calico</td>
<td>Network plugin Calico</td>
</tr>
<tr class="row-even"><td>canal</td>
<td>Network plugin Canal</td>
</tr>
<tr class="row-odd"><td>flannel</td>
<td>Network plugin flannel</td>
</tr>
<tr class="row-even"><td>weave</td>
<td>Network plugin Weave</td>
</tr>
<tr class="row-odd"><td>cloud-provider</td>
<td>Cloud-provider related tasks</td>
</tr>
<tr class="row-even"><td>dnsmasq</td>
<td>Configuring DNS stack for hosts and K8s apps</td>
</tr>
<tr class="row-odd"><td>docker</td>
<td>Configuring docker for hosts</td>
</tr>
<tr class="row-even"><td>download</td>
<td>Fetching container images to a delegate host</td>
</tr>
<tr class="row-odd"><td>etcd</td>
<td>Configuring etcd cluster</td>
</tr>
<tr class="row-even"><td>etcd-pre-upgrade</td>
<td>Upgrading etcd cluster</td>
</tr>
<tr class="row-odd"><td>etcd-secrets</td>
<td>Configuring etcd certs/keys</td>
</tr>
<tr class="row-even"><td>etchosts</td>
<td>Configuring /etc/hosts entries for hosts</td>
</tr>
<tr class="row-odd"><td>facts</td>
<td>Gathering facts and misc check results</td>
</tr>
<tr class="row-even"><td>gce</td>
<td>Cloud-provider GCP</td>
</tr>
<tr class="row-odd"><td>hyperkube</td>
<td>Manipulations with K8s hyperkube image</td>
</tr>
<tr class="row-even"><td>k8s-pre-upgrade</td>
<td>Upgrading K8s cluster</td>
</tr>
<tr class="row-odd"><td>k8s-secrets</td>
<td>Configuring K8s certs/keys</td>
</tr>
<tr class="row-even"><td>kube-apiserver</td>
<td>Configuring static pod kube-apiserver</td>
</tr>
<tr class="row-odd"><td>kube-controller-manager</td>
<td>Configuring static pod kube-controller-manager</td>
</tr>
<tr class="row-even"><td>kubectl</td>
<td>Installing kubectl and bash completion</td>
</tr>
<tr class="row-odd"><td>kubelet</td>
<td>Configuring kubelet service</td>
</tr>
<tr class="row-even"><td>kube-proxy</td>
<td>Configuring static pod kube-proxy</td>
</tr>
<tr class="row-odd"><td>kube-scheduler</td>
<td>Configuring static pod kube-scheduler</td>
</tr>
<tr class="row-even"><td>localhost</td>
<td>Special steps for the localhost (ansible runner)</td>
</tr>
<tr class="row-odd"><td>master</td>
<td>Configuring K8s master node role</td>
</tr>
<tr class="row-even"><td>netchecker</td>
<td>Installing netchecker K8s app</td>
</tr>
<tr class="row-odd"><td>nginx</td>
<td>Configuring LB for kube-apiserver instances</td>
</tr>
<tr class="row-even"><td>node</td>
<td>Configuring K8s minion (compute) node role</td>
</tr>
<tr class="row-odd"><td>openstack</td>
<td>Cloud-provider OpenStack</td>
</tr>
<tr class="row-even"><td>preinstall</td>
<td>Preliminary configuration steps</td>
</tr>
<tr class="row-odd"><td>resolvconf</td>
<td>Configuring <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> for hosts/apps</td>
</tr>
<tr class="row-even"><td>upgrade</td>
<td>Upgrading, f.e. container images/binaries</td>
</tr>
<tr class="row-odd"><td>upload</td>
<td>Distributing images/binaries across hosts</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">使用 <code class="docutils literal notranslate"><span class="pre">bash</span> <span class="pre">scripts/gen_tags.sh</span></code> 命令生成代码库中找到的所有标记的列表。将使用空的 <cite>Used for</cite> 字段列出新标签。</p>
</div>
</div>
<div class="section" id="id3">
<h2>命令示例<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>用于过滤和应用 DNS 配置任务并跳过与主机操作系统配置相关的所有其他内容以及下载容器映像的示例命令：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i inventory/sample/hosts.ini cluster.yml --tags preinstall,dnsmasq,facts --skip-tags=download,bootstrap-os
</pre></div>
</div>
<p>此 play 仅从主机的 <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> 文件中删除K8s群集DNS解析器IP：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i inventory/sample/hosts.ini -e dnsmasq_dns_server=&#39;&#39; cluster.yml --tags resolvconf
</pre></div>
</div>
<p>这样就可以在本地（在 ansible runner 节点）准备所有容器镜像，而无需安装或升级相关内容或尝试将容器上传到K8s集群节点：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i inventory/sample/hosts.ini cluster.yml \
  -e download_run_once=true -e download_localhost=true \
  --tags download --skip-tags upload,upgrade
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">只有当你100％确定自己在做什么时才使用 <code class="docutils literal notranslate"><span class="pre">--tags</span></code> 和 <code class="docutils literal notranslate"><span class="pre">--skip-tags</span></code> 。</p>
</div>
</div>
<div class="section" id="id4">
<h2>堡垒主机<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>如果您不想公开访问节点（仅具有专用IP的节点），则可以使用所谓的堡垒主机连接到您的节点。 要指定和使用堡垒，只需在 inventory 中添加一行，您必须使用堡垒主机的公共IP替换 <code class="docutils literal notranslate"><span class="pre">x.x.x.x</span></code> 。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bastion ansible_ssh_host=x.x.x.x
</pre></div>
</div>
<p>有关Ansible和堡垒主机的更多信息，请阅读 <a class="reference external" href="http://blog.scottlowe.org/2015/12/24/running-ansible-through-ssh-bastion-host/">通过 ssh 堡垒主机运行 Ansible</a> 。</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, renkeju.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'alpha',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>